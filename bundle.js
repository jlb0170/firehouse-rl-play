(()=>{"use strict";var t={88:(t,e,i)=>{i.r(e),i.d(e,{XY:()=>o});var s=i(583),a=i(185),r=i(830),n=i(843);class o{static setSize(t,e){o.w=t,o.h=e}static oob(t,e){return t instanceof o?o.oob(t.x,t.y):t<0||t>=o.w||e<0||e>=o.h}constructor(t,e){this.x=t,this.y=e,this.add=(t,e)=>{if(!Number.isInteger(t)||!Number.isInteger(e))throw new Error(`XY coordinates must be integers: got ${t}, ${e}`);return new o(this.x+t,this.y+e)},this.sub=(t,e)=>this.add(-t,-e),this.subXY=t=>this.add(-t.x,-t.y),this.u=(t=1)=>this.add(0,-t),this.ur=(t=1)=>this.add(t,-t),this.r=(t=1)=>this.add(t,0),this.dr=(t=1)=>this.add(t,t),this.d=(t=1)=>this.add(0,t),this.dl=(t=1)=>this.add(-t,t),this.l=(t=1)=>this.add(-t,0),this.ul=(t=1)=>this.add(-t,-t),this.draw=(t,e,i,a=s.h4)=>t.draw(this.x,this.y,e,i,a),this.cell=t=>t[this.y][this.x],this.cardinals=()=>[this.u(1),this.d(1),this.l(1),this.r(1)].filter((t=>!o.oob(t.x,t.y))),this.neighbors=()=>[this.u(1),this.ur(1),this.r(1),this.dr(1),this.d(1),this.dl(1),this.l(1),this.ul(1)].filter((t=>!o.oob(t.x,t.y))),this.toString=()=>`${this.x}, ${this.y}`,this.on=t=>r.Y.at(this,t),(0,a.Nb)(Number.isInteger(t)&&Number.isInteger(e),(()=>`XY coordinates must be integers: got ${t}, ${e}`))}random(){(0,a.av)(a.Jo,(()=>"can't use random functions in test mode"));const t=this.cardinals();return(0,a.Kt)(t)}onR(t,e=1){const i=this.r(e);o.oob(i.x,i.y)||t(i)}onL(t,e=1){const i=this.l(e);o.oob(i.x,i.y)||t(i)}onU(t,e=1){const i=this.u(e);o.oob(i.x,i.y)||t(i)}onD(t,e=1){const i=this.d(e);o.oob(i.x,i.y)||t(i)}}o.w=n.T.WIDTH,o.h=n.T.HEIGHT,o.at=(t,e)=>new o(t,e)},185:(t,e,i)=>{i.d(e,{$1:()=>g,A7:()=>d,Af:()=>m,C8:()=>y,H3:()=>_,Hn:()=>l,Jo:()=>s,Kt:()=>h,MX:()=>u,Nb:()=>o,__:()=>c,av:()=>n,fv:()=>r,iT:()=>f,jw:()=>p});let s=!1,a="";function r(t){throw console.error(t),a&&console.error("queued at:\n"+a),new Error(t)}function n(t,e){t&&r("function"==typeof e?e():e)}function o(t,e){return n(!t,e),t}function h(t){return n(s,(()=>"can't use random functions in test mode")),n(0===t.length,"need at least one element"),t[Math.floor(Math.random()*t.length)]}function l(t,e){n(t<0,"Cannot iterate negatively");for(let i=0;i<t;i++)e(i)}function c(t,e){for(let i=0;i<t.length;i++)e(t[i],i)}const d=t=>(n(s,(()=>"can't use random functions in test mode")),Math.random()<1/t),u=t=>Math.floor(t/2),p=(t,e)=>Math.floor((t-e.length)/2),g=t=>o(document.getElementById(t),(()=>`No ${t} element`)),m=(t,e)=>t.addEventListener("click",e),f=(t,e)=>t.addEventListener("mousemove",e);function y(t,e){return n(1!==t.length,`Expected exactly one ${e??"item"}, but got ${t.length}`),t[0]}const _=(t,e,i)=>{t.has(e)||t.set(e,[]),t.get(e).push(i)}},583:(t,e,i)=>{i.d(e,{XE:()=>n,ZK:()=>c,h4:()=>r,jA:()=>h,oE:()=>d,u6:()=>a,wB:()=>o});var s=i(185);const a="#0a0",r="#000",n="#444",o="#8B4513",h="#6c200e";class l{constructor(t){this.colors=t}random(){return s.Jo?this.colors[0]:(0,s.Kt)(this.colors)}}const c=new l(["#ff6600","#ff9900","#ffcc00","#ff3300"]),d=new l(["rgba(51,51,51,0.6)","rgba(85,85,85,0.6)","rgba(102,102,102,0.6)","rgba(119,119,119,0.6)","rgba(136,136,136,0.6)","rgba(153,153,153,0.6)","rgba(170,170,170,0.6)","rgba(187,187,187,0.6)","rgba(204,204,204,0.6)"])},830:(t,e,i)=>{i.d(e,{Y:()=>s});class s{constructor(t,e){this.xy=t,this.layer=e,this.toString=()=>s.toString(this.xy,this.layer)}get x(){return this.xy.x}get y(){return this.xy.y}static toString(t,e){return`${e}@(${t.x}, ${t.y})`}static key(t,e){return s.toString(t,e)}static at(t,e){const i=s.toString(t,e);let a=this._cache.get(i);return a||(a=new s(t,e),this._cache.set(i,a)),a}add(t,e){return s.at(this.xy.add(t,e),this.layer)}}s._cache=new Map},843:(t,e,i)=>{i.d(e,{T:()=>M});const s=2.3283064365386963e-10;class a{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*s,t=69069*t+1>>>0,this._s1=t*s,t=69069*t+1>>>0,this._s2=t*s,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*s;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,a;do{i=2*this.getUniform()-1,s=2*this.getUniform()-1,a=i*i+s*s}while(a>1||0==a);return t+i*Math.sqrt(-2*Math.log(a)/a)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,s=this.getUniform()*e,a=0;for(i in t)if(a+=t[i],s<a)return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new a).setState(this.getState())}}(new a).setSeed(Date.now());class r{getContainer(){return null}setOptions(t){this._options=t}}class n extends r{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){const t=this._ctx.globalCompositeOperation;this._ctx.globalCompositeOperation="copy",this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.globalCompositeOperation=t}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}class o extends n{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,a,r,n]=t,o=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&o.reverse(),e&&(this._ctx.fillStyle=n,this._fill(o[0],o[1])),!a)return;this._ctx.fillStyle=r;let h=[].concat(a);for(let t=0;t<h.length;t++)this._ctx.fillText(h[t],o[0],Math.ceil(o[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,s=e/(2+1.5*(this._options.height-1)),a=Math.min(i,s),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let n=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let o=n/100;a=Math.floor(a)+1;let h=2*a/(this._options.spacing*(1+o/Math.sqrt(3)));return Math.ceil(h)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return function(t,e){return(t%e+e)%e}(e=Math.floor(e/s),2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border;const a=this._ctx;a.beginPath(),this._options.transpose?(a.moveTo(t-i+s,e),a.lineTo(t-i/2+s,e+this._spacingX-s),a.lineTo(t+i/2-s,e+this._spacingX-s),a.lineTo(t+i-s,e),a.lineTo(t+i/2-s,e-this._spacingX+s),a.lineTo(t-i/2+s,e-this._spacingX+s),a.lineTo(t-i+s,e)):(a.moveTo(t,e-i+s),a.lineTo(t+this._spacingX-s,e-i/2+s),a.lineTo(t+this._spacingX-s,e+i/2-s),a.lineTo(t,e+i-s),a.lineTo(t-this._spacingX+s,e+i/2-s),a.lineTo(t-this._spacingX+s,e-i/2+s),a.lineTo(t,e-i+s)),a.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,s;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class h extends n{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){h.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[i,s,a,r,n]=t,o=""+a+r+n;if(o in this._canvasCache)e=this._canvasCache[o];else{let t=this._options.border;e=document.createElement("canvas");let i=e.getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=n,i.fillRect(t,t,e.width-t,e.height-t),a){i.fillStyle=r,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(a);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[o]=e}this._ctx.drawImage(e,i*this._spacingX,s*this._spacingY)}_drawNoCache(t,e){let[i,s,a,r,n]=t;if(e){let t=this._options.border;this._ctx.fillStyle=n,this._ctx.fillRect(i*this._spacingX+t,s*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!a)return;this._ctx.fillStyle=r;let o=[].concat(a);for(let t=0;t<o.length;t++)this._ctx.fillText(o[t],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),s=Math.floor(e/this._options.height),a=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let r=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=a;let n=r/100*s/i;return n>1&&(s=Math.floor(s/n)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}h.cache=!1;class l extends n{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,a,r,n]=t,o=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*o,s*h,o,h):(this._ctx.fillStyle=n,this._ctx.fillRect(i*o,s*h,o,h))),!a)return;let l=[].concat(a),c=[].concat(r),d=[].concat(n);for(let t=0;t<l.length;t++){let e=this._options.tileMap[l[t]];if(!e)throw new Error(`Char "${l[t]}" not found in tileMap`);if(this._options.tileColorize){let a=this._colorCanvas,r=a.getContext("2d");r.globalCompositeOperation="source-over",r.clearRect(0,0,o,h);let n=c[t],l=d[t];r.drawImage(this._options.tileSet,e[0],e[1],o,h,0,0,o,h),"transparent"!=n&&(r.fillStyle=n,r.globalCompositeOperation="source-atop",r.fillRect(0,0,o,h)),"transparent"!=l&&(r.fillStyle=l,r.globalCompositeOperation="destination-over",r.fillRect(0,0,o,h)),this._ctx.drawImage(a,i*o,s*h,o,h)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],o,h,i*o,s*h,o,h)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}function c(t){let e,i;if(t in d)e=d[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map((t=>parseInt(t,16)));if(3==i.length)e=i.map((t=>17*t));else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map((t=>parseInt(t))):[0,0,0];d[t]=e}return e.slice()}const d={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]};class u extends r{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){"string"==typeof t?alert(t):t instanceof Error&&alert(t.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",(()=>this._updateTexture(e))):this._updateTexture(e)}draw(t,e){const i=this._gl,s=this._options;let[a,r,n,o,h]=t,l=i.canvas.height-(r+1)*s.tileHeight;if(i.scissor(a*s.tileWidth,l,s.tileWidth,s.tileHeight),e&&(s.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...y(h)),i.clear(i.COLOR_BUFFER_BIT)),!n)return;let c=[].concat(n),d=[].concat(h),u=[].concat(o);i.uniform2fv(this._uniforms.targetPosRel,[a,r]);for(let t=0;t<c.length;t++){let e=this._options.tileMap[c[t]];if(!e)throw new Error(`Char "${c[t]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,s.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,e),s.tileColorize&&(i.uniform4fv(this._uniforms.tint,y(u[t])),i.uniform4fv(this._uniforms.bg,y(d[t]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(...y(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=function(t,e,i){const s=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(s)||"");const a=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(a,i),t.compileShader(a),!t.getShaderParameter(a,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(a)||"");const r=t.createProgram();if(t.attachShader(r,s),t.attachShader(r,a),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(r)||"");return r}(t,g,m);return t.useProgram(e),function(t){const e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(t),p.forEach((i=>this._uniforms[i]=t.getUniformLocation(e,i))),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){!function(t,e){let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}(this._gl,t)}}const p=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],g="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),m="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim();let f={};function y(t){if(!(t in f)){let e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else e=c(t).map((t=>t/255)),e.push(1);f[t]=e}return f[t]}function _(t){const e=6/256;let i=c(t);return 36*Math.floor(i[0]*e)+6*Math.floor(i[1]*e)+1*Math.floor(i[2]*e)+16}class w extends r{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map(((t,i)=>Math.floor((t-e[i])/2)))}clear(){process.stdout.write(`[0;48;5;${_(this._options.bg)}m[2J`)}draw(t,e){let[i,s,a,r,n]=t,o=this._offset[0]+i,h=this._offset[1]+s,l=this.computeSize();if(o<0||o>=l[0])return;if(h<0||h>=l[1])return;if(o===this._cursor[0]&&h===this._cursor[1]||(process.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(o,h)),this._cursor[0]=o,this._cursor[1]=h),e&&(a||(a=" ")),!a)return;let c=function(t,e){return`[0;38;5;${_(t)};48;5;${_(e)}m`}(r,n);if(c!==this._lastColor&&(process.stdout.write(c),this._lastColor=c),"\t"!=a){let t=[].concat(a);process.stdout.write(t[0])}this._cursor[0]++,this._cursor[0]>=l[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const x=/%([bc]){([^}]*)}/g;function b(t,e,i,s){let a={type:0,value:t[e].value.substring(i+(s?1:0))};return t.splice(e+1,0,{type:1},a),t[e].value.substring(0,i)}const v={hex:o,rect:h,tile:l,"tile-gl":u,term:w},S={width:80,height:25,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class T{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},S,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let s=[this._options.bg,this._options.fg];this.draw(t,e,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=v[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,s,a){s||(s=this._options.fg),a||(a=this._options.bg);let r=`${t},${e}`;this._data[r]=[t,e,i,s,a],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[r]=!0)}drawOver(t,e,i,s,a){const r=`${t},${e}`,n=this._data[r];n?(n[2]=i||n[2],n[3]=s||n[3],n[4]=a||n[4]):this.draw(t,e,i,s,a)}drawText(t,e,i,s){let a=null,r=null,n=t,o=e,h=1;s||(s=this._options.width-t);let l=function(t,e){let i=[],s=0;t.replace(x,(function(e,a,r,n){let o=t.substring(s,n);return o.length&&i.push({type:0,value:o}),i.push({type:"c"==a?2:3,value:r.trim()}),s=n+e.length,""}));let a=t.substring(s);return a.length&&i.push({type:0,value:a}),function(t,e){e||(e=1/0);let i=0,s=0,a=-1;for(;i<t.length;){let r=t[i];if(1==r.type&&(s=0,a=-1),0!=r.type){i++;continue}for(;0==s&&" "==r.value.charAt(0);)r.value=r.value.substring(1);let n=r.value.indexOf("\n");if(-1!=n){r.value=b(t,i,n,!0);let e=r.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();r.value=e.join("")}if(r.value.length){if(s+r.value.length>e){let n=-1;for(;;){let t=r.value.indexOf(" ",n+1);if(-1==t)break;if(s+t>e)break;n=t}if(-1!=n)r.value=b(t,i,n,!0);else if(-1!=a){let e=t[a],s=e.value.lastIndexOf(" ");e.value=b(t,a,s,!0),i=a}else r.value=b(t,i,e-s,!1)}else s+=r.value.length,-1!=r.value.indexOf(" ")&&(a=i);i++}else t.splice(i,1)}t.push({type:1});let r=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case 0:r=i;break;case 1:if(r){let t=r.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();r.value=t.join("")}r=null}}return t.pop(),t}(i,e)}(i,s);for(;l.length;){let e=l.shift();switch(e.type){case 0:let i=!1,s=!1,l=!1,c=!1;for(let t=0;t<e.value.length;t++){let h=e.value.charCodeAt(t),d=e.value.charAt(t);if("term"===this._options.layout){let t=h>>8;if(17===t||t>=46&&t<=159||t>=172&&t<=215||h>=43360&&h<=43391){this.draw(n+0,o,d,a,r),this.draw(n+1,o,"\t",a,r),n+=2;continue}}l=h>65280&&h<65377||h>65500&&h<65512||h>65518,i=32==d.charCodeAt(0)||12288==d.charCodeAt(0),!c||l||i||n++,l&&!s&&n++,this.draw(n++,o,d,a,r),s=i,c=l}break;case 2:a=e.value||null;break;case 3:r=e.value||null;break;case 1:n=t,o++,h++}}return h}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}T.Rect=h,T.Hex=o,T.Tile=l,T.TileGL=u,T.Term=w,Math.sqrt(3),Math.sqrt(3);var E=i(583);class M{static createDisplay(t,e){return new T({width:t,height:e,fontSize:M.FONT_SIZE,fontFamily:M.FONT_FAMILY,forceSquareRatio:!0,fg:E.u6,bg:E.h4})}static createTransparentDisplay(t,e){return new T({width:t,height:e,fontSize:M.FONT_SIZE,fontFamily:M.FONT_FAMILY,forceSquareRatio:!0,fg:E.u6,bg:"transparent"})}}M.WIDTH=90,M.HEIGHT=50,M.FONT_SIZE=16,M.FONT_FAMILY="Courier, monospace"}},e={};function i(s){var a=e[s];if(void 0!==a)return a.exports;var r=e[s]={exports:{}};return t[s](r,r.exports,i),r.exports}i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s=i(185),a=i(88);class r{constructor(){this.data={}}draw(t,e,i){r.layerNames.some((s=>{if(t.size>0&&!t.has(s))return!1;const a=this.data[s];return!!a?.draw&&a.draw(e,i)}))}step(){r.layerNames.forEach((t=>{const e=this.data[t];e&&(e.step(),e.age++)}))}set(t){this.data[t.layer]=t}onExisting(t,e){const i="string"==typeof t?t:t.layer,s=this.data[i];s&&e(s)}remove(t){delete this.data[t.layer],t.cell=null}passable(){return r.layerNames.every((t=>{const e=this.data[t];return e?.passable??!0}))}transparency(){if(this.data.ui)return this.data.ui.transparency;const t=r.layerNames.map((t=>this.data[t]?.transparency)).filter((t=>void 0!==t));return t.length>0?Math.min(...t):1}lit(){return r.layerNames.some((t=>{const e=this.data[t];return e&&e.light()>0}))}}r.layerNames=["ui","pawn","smoke","fire","walls","items","floor"];var n=i(830);class o{constructor(t,e){this.layers=new r,this.passable=()=>this.layers.passable(),this.wall=()=>this.layers.data.walls,this.pawn=()=>this.layers.data.pawn,this.fire=()=>this.layers.data.fire,this.smoke=()=>this.layers.data.smoke,this.floor=()=>this.layers.data.floor,this.items=()=>this.layers.data.items,this.ui=()=>this.layers.data.ui,this.neighbors=()=>this.xy.cardinals().map((t=>this.map.get(t))),this.u=(t=1)=>this.map.get(this.xy.u(t)),this.d=(t=1)=>this.map.get(this.xy.d(t)),this.l=(t=1)=>this.map.get(this.xy.l(t)),this.r=(t=1)=>this.map.get(this.xy.r(t)),this.ul=(t=1)=>this.map.get(this.xy.ul(t)),this.ur=(t=1)=>this.map.get(this.xy.ur(t)),this.dl=(t=1)=>this.map.get(this.xy.dl(t)),this.dr=(t=1)=>this.map.get(this.xy.dr(t)),this.xy=t,this.map=e}draw(t,e,i,s){const a=this.map.lighting.at(this);if(t){const t=Math.floor(a).toString();if("0"!==t)return void this.map.drawAt(this.xy.x,this.xy.y,t,"#fff","#000")}i||this.layers.draw(e,s,a)}step(){this.layers.step()}reborn(t){this.layers.onExisting(t,(t=>this.died(t))),this.create(t)}set(t){(0,s.Nb)(t.born,(()=>`tried to set raw constructed drawable ${t.desc()} - should be created with create()`)),this.layers.onExisting(t,(e=>{(0,s.fv)(`tried to replace ${e.desc()} with ${t.desc()}`)})),this.layers.set(t),t.movedInto(this),this.map.lighting.update(this)}remove(t){this.layers.remove(t),this.map.lighting.update(this)}died(t){this.remove(t),t.diedAndAlreadyRemovedFromCell()}occupied(t){return!!this.layers.data[t]}occupantIs(t){return this.layers.data[t.layer]===t}queueMove(t,e){this.map.moving(t,n.Y.at(this.xy,t.layer),n.Y.at(e,t.layer))}create(t){return this.map.create(this,t)}bombOccupied(t,e){(0,s.av)(this.occupied(t),(()=>`Cell is occupied: ${e(this.layers.data[t])}`))}}var h=i(843);const l=(t,e,i)=>{let s=t.x,r=t.y;const n=e.x,o=e.y;let h=Math.abs(n-s),l=s<n?1:-1,c=-Math.abs(o-r),d=r<o?1:-1,u=h+c;for(;i(a.XY.at(s,r))&&(s!==n||r!==o);){const t=u<<1;t>=c&&(u+=c,s+=l),t<=h&&(u+=h,r+=d)}};class c{constructor(t){this.map=t,this._sources=new Set,this.atXY=t=>t.x<0||t.x>=this.map.w||t.y<0||t.y>=this.map.h?0:this._illumination[t.y][t.x]??0,this.at=t=>this.atXY(t.xy),this._illumination=Array.from({length:t.h},(()=>new Array(t.w))),this.clear()}clear(){this._illumination.forEach((t=>t.fill(0)))}add(t){this._sources.add(t)}remove(t){this._sources.delete(t)}update(t){t.layers.lit()?this.add(t):this.remove(t)}transparencyOf(t,e){return a.XY.oob(t,e)?1:this.map.get(a.XY.at(t,e)).layers.transparency()}redraw(){this.clear();for(const t of this._sources){const e=Math.min(Object.values(t.layers.data).reduce(((t,e)=>t+(e?.light()??0)),0),9);if(!(e<=0))for(let i=-e;i<=e;i++)for(let s=-e;s<=e;s++){const r=t.xy.x+s,n=t.xy.y+i;if(a.XY.oob(r,n))continue;if(s*s+i*i>e*e)continue;let o=1;if(l(t.xy,a.XY.at(r,n),(i=>{const s=i.subXY(t.xy),a=c.quadraticFallOff(e,s.x,s.y),r=Math.round(a*o);return r>this.atXY(i)&&this.set(i,r),i.x===t.xy.x&&i.y===t.xy.y||(o*=this.transparencyOf(i.x,i.y),o>0)})),o<=0)continue;const h=c.quadraticFallOff(e,s,i),d=Math.round(h*o);d>this._illumination[n][r]&&(this._illumination[n][r]=d)}}}set(t,e){this._illumination[t.y][t.x]=e}sources(){return this._sources}lit(t){return this._sources.has(t)}static quadraticFallOff(t,e,i){const s=e*e+i*i;return s>t*t?0:t-((s+(t>>1))/t|0)}}class d{constructor(t,e,i){this.drawable=t,this.from=e,this.to=i}}class u{constructor(t){this.map=t,this.moves=[]}queue(t,e,i){(0,s.Nb)(e!==i,"cant queue move to same cell");const a=Math.abs(e.x-i.x),r=Math.abs(e.y-i.y);(0,s.Nb)(1===Math.max(a,r),"move must be adjacent"),(0,s.Nb)(this.map.get(i.xy).passable(),"destination is not passable"),this.moves.push(new d(t,e,i))}clear(){this.moves=[]}move(){const t=new Set(this.moves.filter((t=>this.map.get(t.from.xy).occupantIs(t.drawable))));for(this.clear();t.size>0;){const e=this.movable(t);if(0===e.length)return;this.execute(e),e.forEach((e=>t.delete(e)))}}movable(t){const e=new Map;t.forEach((t=>(0,s.H3)(e,t.to,t)));const i=[];return e.forEach(((t,e)=>{if(1!==t.length)return;const a=(0,s.C8)(t);this.map.get(e.xy).occupied(a.drawable.layer)||i.push(a)})),i}execute(t){t.forEach((t=>this.map.get(t.from.xy).remove(t.drawable))),t.forEach((t=>this.map.get(t.to.xy).set(t.drawable)))}}var p=i(583);class g{constructor(){this.id=g.nextId++,this.born=!1,this.age=0,this.passable=!0,this.transparency=1,this.cell=null,g.alive.add(this)}step(){}desc(){return`${this.typeName}(${this.id})`}draw(t,e){const i=this.applyIllumination(this.color(),e);return this.cell.map.drawAt(this.cell.xy.x,this.cell.xy.y,this.char(),i,p.h4),!0}movedInto(t){this.cell=t}applyIllumination(t,e){if(!t.startsWith("#"))return t;const i=Math.min(e,9)/9,s=Math.max(0,i);let a,r,n;if(4===t.length)a=parseInt(t[1]+t[1],16),r=parseInt(t[2]+t[2],16),n=parseInt(t[3]+t[3],16);else{if(7!==t.length)return t;a=parseInt(t.slice(1,3),16),r=parseInt(t.slice(3,5),16),n=parseInt(t.slice(5,7),16)}const o=Math.floor(a*s),h=Math.floor(r*s),l=Math.floor(n*s);return`#${o.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`}r(){return this.cell.r()}l(){return this.cell.l()}u(){return this.cell.u()}d(){return this.cell.d()}ur(){return this.cell.ur()}ul(){return this.cell.ul()}dr(){return this.cell.dr()}dl(){return this.cell.dl()}queueMove(t){this.cell.queueMove(this,t instanceof a.XY?t:t.cell.xy)}olderThan(t){return this.age>t.age}merge(t,e){throw new Error("merge not implemented")}diedAndAlreadyRemovedFromCell(){g.alive.delete(this)}}g.alive=new Set,g.nextId=0;class m{constructor(t,e){this.stepCallbacks={},this.frameNumber=0,this.get=t=>{const e=t.cell(this.grid);return(0,s.Nb)(e,(()=>"No cell at "+t)),e},this.coordsFromEvent=(t,e)=>{const i=e.getBoundingClientRect(),s=Math.floor((t.clientX-i.left)/h.T.FONT_SIZE),r=Math.floor((t.clientY-i.top)/h.T.FONT_SIZE);return a.XY.at(s,r)},this.eachLocation=t=>this.eachCell((e=>r.layerNames.forEach((i=>t(e.xy.on(i)))))),this.eachCell=t=>(0,s.Hn)(this.h,(e=>(0,s.Hn)(this.w,(i=>t(this.grid[e][i]))))),m.active.add(this),this.display=h.T.createDisplay(t,e),this.smokeDisplay=h.T.createTransparentDisplay(t,e),this.uiDisplay=h.T.createTransparentDisplay(t,e),this.w=t,this.h=e,this.grid=[],(0,s.Hn)(e,(e=>{this.grid[e]=[],(0,s.Hn)(t,(t=>{this.grid[e][t]=new o(a.XY.at(t,e),this)}))})),a.XY.setSize(t,e),this.lighting=new c(this),this.movers=new u(this)}drawAt(t,e,i,s,a){this.display.draw(t,e,i,s,a)}drawAtSmoke(t,e,i,s,a){this.smokeDisplay.draw(t,e,i,s,a)}drawAtUi(t,e,i,s,a){this.uiDisplay.draw(t,e,i,s,a)}clearUi(){this.uiDisplay.clear()}draw(t,e,i,a){this.display.clear(),this.smokeDisplay.clear(),this.uiDisplay.clear(),(0,s.Hn)(this.h,(r=>{(0,s.Hn)(this.w,(s=>{this.grid[r][s].draw(t,e,i,a)}))}))}step(){(0,s.Hn)(this.h,(t=>{(0,s.Hn)(this.w,(e=>{this.grid[t][e].step()}))})),this.frameNumber++,Object.values(this.stepCallbacks).forEach((t=>t(this.frameNumber))),this.movers.move(),(t=>{const e=new Set;t.eachLocation((i=>{const s=t.get(i.xy).layers.data[i.layer];s&&e.add(s)}));const i=[...g.alive].filter((t=>!e.has(t)));i.length&&((0,s.__)(i,(t=>g.alive.delete(t))),(0,s.fv)(`drawable leaked ${i.map((t=>`${t.constructor.name}:${!!t.cell}`)).join(", ")}`))})(this)}runOnStep(t,e){(0,s.av)(t in this.stepCallbacks,(()=>`Step callback '${t}' already exists`)),this.stepCallbacks[t]=e}set(t,e){const i=t.cell(this.grid);return(0,s.Nb)(i,(()=>"No cell at "+t)),i.set(e),i}createAt(t,e){return this.get(t).create(e)}create(t,e){return e.born=!0,t.bombOccupied(e.layer,(t=>`can't create ${e.desc()} on top of ${t.desc()}`)),t.set(e),e}moving(t,e,i){this.movers.queue(t,e,i)}eachRay(t,e,i){let s=0;l(t,e,(t=>{if(a.XY.oob(t))return!1;const e=this.get(t);return i(e,s++)}))}flashRayFrom(t,e,i){this.eachRay(t.xy,e.xy,((e,s)=>e===t||!!i(e)&&(this.drawAtUi(e.xy.x,e.xy.y,"*","#00f","transparent"),!0)))}onClick(t,e){const i=i=>{const s=this.coordsFromEvent(i,t);a.XY.oob(s.x,s.y)||e(this.get(s))};(0,s.Af)(t,i),t.addEventListener("contextmenu",(t=>{t.preventDefault(),i(t)}))}onMousemove(t,e){(0,s.iT)(t,(i=>{const s=this.coordsFromEvent(i,t);a.XY.oob(s.x,s.y)||e(this.get(s))}))}renderToChars(t="drawAt"){const e=[];(0,s.Hn)(this.h,(t=>{e[t]=[],(0,s.Hn)(this.w,(i=>{e[t][i]="."}))}));const i=this[t];this[t]=(i,s,r,n,o)=>{const h=this.get(a.XY.at(i,s));"drawAt"===t&&h.pawn()?e[s][i]=h.pawn().desc()[0]:e[s][i]=r},this.draw(!1,new Set,!1,!1),this[t]=i;let r="\n";return(0,s.Hn)(this.h,(t=>{(0,s.Hn)(this.w,(i=>{r+=e[t][i]})),r+="\n"})),r}fill(t){this.eachCell((e=>e.create(t())))}killAll(){this.eachCell((t=>r.layerNames.forEach((e=>{const i=t.layers.data[e];i&&t.died(i)}))))}}m.active=new Set;class f extends g{constructor(){super(...arguments),this.layer="smoke",this.typeName="Smoke",this.transparency=.1,this.light=()=>0,this.char=()=>"+",this.color=()=>p.oE.random()}draw(t,e){const i=this.color();return this.cell.map.drawAtSmoke(this.cell.xy.x,this.cell.xy.y,this.char(),i,"transparent"),!1}agedOut(){return s.Jo?this.age>3:!(0,s.A7)(this.age/3)}shouldDrift(){return s.Jo?this.age%4==0:(0,s.A7)(4)}driftTo(){if(s.Jo){const t=this.r();return a.XY.oob(t.xy.x,t.xy.y)?this.l():t}return this.cell.map.get(this.cell.xy.random())}drift(){const t=this.driftTo();t.passable()&&this.cell.queueMove(this,t.xy)}step(){this.agedOut()?this.cell.died(this):this.shouldDrift()&&this.drift()}}class y extends g{constructor(){super(...arguments),this.layer="fire",this.typeName="Fire",this.light=()=>5,this.char=()=>"▲",this.color=()=>p.ZK.random()}step(){if((0,s.A7)(this.age)){if(this.cell.reborn(new f),this.cell.layers.data.walls&&this.cell.layers.data.walls.ignite(),(0,s.A7)(4)&&(0,s.Kt)(this.cell.neighbors()).reborn(new y),(0,s.A7)(4)){const t=(0,s.Kt)(this.cell.neighbors());if(!t.passable())return;this.cell.queueMove(this,t.xy)}}else this.cell.died(this)}merge(t){return(0,s.Nb)(t instanceof y,"merge mismatch"),t.olderThan(this)?"replace":"kill"}}class _ extends g{constructor(){super(...arguments),this.layer="walls",this.typeName="Wall",this.passable=!1,this.transparency=0,this.isDoor=!1,this.burningFor=null,this.char=()=>this.isDoor?"+":"#",this.color=()=>this.isBurning()?p.jA:this.isDoor?p.wB:p.XE,this.light=()=>this.isBurning()?1:0,this.desc=()=>`${this.isDoor?"Door":this.typeName}(${this.id})`,this.makeDoor=()=>{this.isDoor=!0,this.passable=!0},this.isBurning=()=>null!==this.burningFor}step(){this.isBurning()&&((0,s.A7)(2)&&this.cell.reborn(new f),this.burningFor<=0?this.cell.died(this):(this.burningFor--,(0,s.A7)(2)&&this.cell.reborn(new y)))}ignite(){this.isBurning()||(this.burningFor=20)}}class w extends g{constructor(t,e=p.u6){super(),this.c=t,this.textColor=e,this.layer="ui",this.typeName="UI",this.light=()=>9,this.char=()=>this.c,this.color=()=>this.textColor,this.step=()=>this.cell.died(this)}}class x{constructor(t,e,i){this.xy=t,this.w=e,this.h=i,this.eachCell=t=>(0,s.Hn)(this.w,(e=>(0,s.Hn)(this.h,(i=>t(this.xy.add(e,i))))))}get ul(){return this.xy}get ur(){return this.xy.add(this.w-1,0)}get bl(){return this.xy.add(0,this.h-1)}get br(){return this.xy.add(this.w-1,this.h-1)}get cb(){return this.xy.add((0,s.MX)(this.w),this.h-1)}get cl(){return this.xy.add(0,(0,s.MX)(this.h))}get cr(){return this.xy.add(this.w-1,(0,s.MX)(this.h))}get uc(){return this.xy.add((0,s.MX)(this.w),0)}eachBorder(t){(0,s.Hn)(this.w,(e=>{t(this.xy.add(e,0)),t(this.xy.add(e,this.h-1))})),(0,s.Hn)(this.h-2,(e=>{t(this.xy.add(0,e+1)),t(this.xy.add(this.w-1,e+1))}))}}x.xyWH=(t,e,i)=>new x(t,e,i);class b extends g{constructor(){super(...arguments),this.layer="floor",this.typeName="Floor",this.light=()=>0,this.char=()=>".",this.color=()=>p.XE}}class v extends g{constructor(){super(...arguments),this.layer="fire",this.typeName="Torch",this.transparency=1,this.light=()=>5,this.char=()=>"*",this.color=()=>p.ZK.random()}smoking(){return!!s.Jo||(0,s.A7)(3)}step(){this.smoking()&&this.cell.reborn(new f)}}class S extends g{constructor(t){super(),this.name=t,this.selected=!1,this.destination=null,this.typeName="Pawn",this.layer="pawn",this.transparency=0,this.light=()=>3,this.char=()=>"@",this.color=()=>p.u6,this.onMapClicked=t=>{this.destination=t,this.flashDestination()},this.clearDestination=()=>{this.destination=null},this.task=()=>this.destination?`destination: ${this.destination.xy.toString()}`:"idle"}desc(){return this.name?`${this.name}(${this.id})`:`${this.typeName}(${this.id})`}draw(t,e){return this.flashDestination(),this.selected?(this.cell.map.drawAt(this.cell.xy.x,this.cell.xy.y,this.char(),p.h4,p.u6),!0):super.draw(t,9)}arrived(){return this.clearDestination(),!1}step(){this.destination&&this.stepToward()}movedInto(t){super.movedInto(t),this.cell===this.destination&&this.arrived()}flashDestination(){this.destination&&this.cell.map.flashRayFrom(this.cell,this.destination,(t=>t.passable()))}stepToward(){this.cell.map.eachRay(this.cell.xy,this.destination.xy,((t,e)=>t===this.cell||(t.passable()?(this.cell.queueMove(this,t.xy),!1):this.arrived())))}}const T=["#   #  ###  ####  #     ####       ###  #   #      ##### ##### ####  #####","#   # #   # #   # #     #   #     #   # ##  #      #       #   #   # #    ","# # # #   # ####  #     #   #     #   # # # #      ####    #   ####  #### ","# # # #   # #   # #     #   #     #   # #  ##      #       #   #   # #    ","## ## #   # #   # #     #   #     #   # #   #      #       #   #   # #    ","#   #  ###  #   # ##### ####       ###  #   #      #     ##### #   # #####"];class E{constructor(t){this.map=t}initialize(){this.addField(),this.addTitle(),this.addWelcomeText(),this.addPawn(),this.addBarracks(),this.addUserSuggestion()}addField(){x.xyWH(a.XY.at(0,0),this.map.w,this.map.h).eachCell((t=>{this.map.createAt(t,new b)}))}addTitle(){const t=T[0].length,e=T.length,i=(0,s.jw)(this.map.w,T[0]),r=Math.floor((this.map.h-e)/2),n=a.XY.at(i,r);this.addRoom(x.xyWH(n.add(-1,-1),t+2,e+2)),(0,s.__)(T,((t,e)=>{(0,s.__)(t,((t,i)=>{"#"===t&&this.map.createAt(n.add(i,e),new y)}))}))}addWelcomeText(){this.addCenteredText("Welcome to Fire House RL",-13),this.addCenteredText("press space to unpause",13)}addCenteredText(t,e){const i=(0,s.MX)(this.map.h)+e,r=(0,s.jw)(this.map.w,t);this.addUIText(t,a.XY.at(r,i))}addPawn(){this.map.createAt(a.XY.at(55,24),new S("firefighter 1"))}addRoom(t){t.eachBorder((t=>{this.map.createAt(t,new _)})),[t.ul.add(1,1),t.ur.add(-1,1),t.bl.add(1,-1),t.br.add(-1,-1)].forEach((t=>{this.map.createAt(t,new v)}))}addBarracks(){const t=x.xyWH(a.XY.at(60,8),9,9);this.addRoom(t);const e=this.map.get(t.cl);e.wall().makeDoor(),e.l().u().create(new v),e.l().d().create(new v)}addUserSuggestion(){const t=t=>{if(t%5!=0)return;const e=this.map.h-1,i="click the @ symbol",r=(0,s.jw)(this.map.w,i);this.addUIText(i,a.XY.at(r,e))};t(0),this.map.runOnStep("user.suggest",t)}addUIText(t,e){(0,s.__)(t,((t,i)=>this.map.createAt(e.add(i,0),new w(t))))}}class M{constructor(){this.currentCell=null,this.selectedPawn=null,this.setCurrent=t=>this.currentCell=t,this.setSelected=t=>this.selectedPawn=t,this.clear=()=>{this.element.innerHTML="",this.selectedElement.innerHTML=""},this.element=(0,s.$1)("terminal-content"),this.selectedElement=(0,s.$1)("selected-info")}draw(){if(!this.currentCell)return void(this.element.innerHTML='<div class="layer-info">no cell selected</div>');this.currentCell.layers.transparency(),this.currentCell.map.lighting.lit(this.currentCell),this.currentCell.map.lighting.at(this.currentCell);let t=`<div class="cell-coord">${this.currentCell.xy.x}, ${this.currentCell.xy.y}</div>`;const e=this.currentCell.layers.data,i=r.layerNames.filter((t=>e[t])).map((t=>[t,e[t]]));if(0===i.length?t+='<div class="layer-info">empty</div>':i.forEach((([e,i])=>{const s=i.color(this.currentCell),a=i.light()>0?` (light: ${i.light()})`:"";t+=`<div class="layer-info">${e}: <span style="color: ${s}">${i.desc()}${a}</span></div>`})),this.element.innerHTML=t,this.selectedPawn){const t=this.selectedPawn.task(),e="idle"!==t,i=e?' <span class="clear-dest" style="cursor: pointer; color: #f44; font-weight: bold;">[x]</span>':"";if(this.selectedElement.innerHTML=`<div class="layer-info">${this.selectedPawn.desc()}</div><div class="layer-info">${t}${i}</div>`,e){const t=this.selectedElement.querySelector(".clear-dest");t&&t.addEventListener("click",(()=>{this.selectedPawn.clearDestination(),this.draw()}))}}else this.selectedElement.innerHTML=""}}class C{constructor(){this.intervalId=null,this.running=!1,this.showLighting=!1,this.mutedLayers=new Set,this.soloLayer=null,this.selectedPawn=null,this.stepN=0,this.stepMs=0,this.lastLine=0,this.flash=!1,this.updateStepInfo=()=>{(0,s.$1)("step-info").textContent=`${this.stepN} ${this.stepMs}ms`},this.map=new m(h.T.WIDTH,h.T.HEIGHT),this.terminal=new M,this.attachToDOM(),this.setupControls(),this.setupDebugControls(),new E(this.map).initialize(),this.map.lighting.redraw(),this.drawMap(),this.map.runOnStep("game.stepInfo",(t=>this.stepN=t)),this.updatePlayPauseButton(),this.updateStepInfo(),document.addEventListener("keydown",(t=>{" "===t.key&&(t.preventDefault(),this.togglePlayPause())}))}selectPawn(t){this.unselectPawn(),t.selected=!0,this.selectedPawn=t,this.terminal.setSelected(t)}unselectPawn(){this.selectedPawn&&(this.selectedPawn.selected=!1,this.selectedPawn=null,this.terminal.setSelected(null),this.map.clearUi())}attachToDOM(){const t=(0,s.Nb)(document.getElementById("game-container"),(()=>"No game-container element")),e=(0,s.Nb)(this.map.display.getContainer(),(()=>"Failed to get canvas")),i=(0,s.Nb)(this.map.smokeDisplay.getContainer(),(()=>"Failed to get smoke canvas")),a=(0,s.Nb)(this.map.uiDisplay.getContainer(),(()=>"Failed to get ui canvas"));t.style.position="relative",e.style.display="block",e.style.zIndex="1",i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.zIndex="2",i.style.pointerEvents="none",a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.zIndex="3",a.style.pointerEvents="none",t.appendChild(e),t.appendChild(i),t.appendChild(a),this.map.onMousemove(e,(t=>this.onMouseMove(t))),this.map.onClick(e,(t=>{const e=t.pawn();this.selectedPawn?e===this.selectedPawn?this.unselectPawn():this.selectedPawn.onMapClicked(t):e&&this.selectPawn(e),this.drawMap(),this.terminal.draw()}))}setupControls(){(0,s.Af)((0,s.$1)("playpause-button"),(()=>this.togglePlayPause())),(0,s.Af)((0,s.$1)("next-button"),(()=>this.step()))}setupDebugControls(){(0,s.Af)((0,s.$1)("lighting-toggle"),(()=>this.toggleLighting())),(0,s.Af)((0,s.$1)("layer-on"),(()=>this.turnOnAllLayers())),(0,s.Af)((0,s.$1)("layer-off"),(()=>this.turnOffAllLayers())),this.createLayerButtons(),r.layerNames.forEach((t=>{(0,s.Af)((0,s.$1)(`layer-${t}`),(()=>this.toggleLayerVisibility(t)))}))}updatePlayPauseButton(){(0,s.$1)("playpause-button").textContent=this.running?"⏸":"▶"}togglePlayPause(){this.running?this.pause():this.play()}pause(){this.running&&(this.running=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.updatePlayPauseButton())}play(){this.running||(this.running=!0,this.intervalId=setInterval((()=>this.step()),350),this.updatePlayPauseButton())}step(){const t=Date.now();this.map.step(),this.map.lighting.redraw(),this.drawMap(),this.terminal.draw(),this.stepMs=Date.now()-t,this.updateStepInfo()}drawMap(){const t=this.getVisibleLayers(),e=this.mutedLayers.size===r.layerNames.length,i=this.mutedLayers.size>0||null!==this.soloLayer;this.map.draw(this.showLighting,t,e,i)}getVisibleLayers(){return this.soloLayer?new Set([this.soloLayer]):0===this.mutedLayers.size?new Set:new Set(r.layerNames.filter((t=>!this.mutedLayers.has(t))))}toggleLighting(){this.showLighting=!this.showLighting,(0,s.$1)("lighting-toggle").textContent=this.showLighting?"LT*":"LT",this.drawMap()}toggleLayerVisibility(t){const e=(0,s.$1)(`layer-${t}`);this.soloLayer===t?(this.soloLayer=null,e.classList.remove("solo")):this.soloLayer?((0,s.$1)(`layer-${this.soloLayer}`).classList.remove("solo"),this.soloLayer=t,e.classList.add("solo")):this.mutedLayers.has(t)?(this.mutedLayers.delete(t),e.classList.remove("muted")):(this.mutedLayers.add(t),e.classList.add("muted")),this.drawMap()}turnOnAllLayers(){this.mutedLayers.clear(),this.soloLayer=null,r.layerNames.forEach((t=>{(0,s.$1)(`layer-${t}`).classList.remove("muted","solo")})),this.drawMap()}turnOffAllLayers(){this.soloLayer=null,this.mutedLayers=new Set(r.layerNames),r.layerNames.forEach((t=>{const e=(0,s.$1)(`layer-${t}`);e.classList.remove("solo"),e.classList.add("muted")})),this.drawMap()}onMouseMove(t){this.terminal.setCurrent(t);const e=Date.now();if(!this.selectedPawn)return this.map.clearUi(),void this.terminal.draw();if("idle"!==this.selectedPawn.task())return this.map.clearUi(),void this.terminal.draw();if(e-this.lastLine<50)return void this.terminal.draw();this.lastLine=e,this.map.clearUi();const i=this.selectedPawn.cell.xy,s=t.xy,a=this.flash?"#0ff":"#088";this.map.eachRay(i,s,((t,e)=>t===this.selectedPawn.cell||!!t.passable()&&(this.map.drawAtUi(t.xy.x,t.xy.y,"*",a,"transparent"),!0))),this.flash=!this.flash,this.terminal.draw()}createLayerButtons(){const t=(0,s.$1)("layer-group"),e=Object.fromEntries(r.layerNames.map((t=>[t,"ui"===t?"ui ":t.slice(0,3)])));r.layerNames.forEach((i=>{const s=document.createElement("button");s.id=`layer-${i}`,s.className="layer-button",s.textContent=e[i]||i.slice(0,3),t.appendChild(s)}))}}function P(t,e){const i=document.getElementById("game-container")||document.body,s=document.createElement("div");s.className="error-overlay";const a=document.createElement("button");a.className="error-close",a.textContent="×",a.addEventListener("click",(()=>s.remove())),s.textContent=`ERROR: ${t}\n\nStack trace:\n${e||"No stack trace available"}`,s.appendChild(a),i.appendChild(s)}window.addEventListener("error",(t=>{console.error("Global error:",t.error),console.error("Stack trace:",t.error?.stack),P(t.error?.message||"Unknown error",t.error?.stack)})),window.addEventListener("DOMContentLoaded",(function(){try{new C}catch(t){P(`Game initialization failed: ${t instanceof Error?t.message:"Unknown error"}`,t instanceof Error?t.stack:void 0)}}))})();