(()=>{"use strict";const t=2.3283064365386963e-10;class e{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*t,e=69069*e+1>>>0,this._s1=e*t,e=69069*e+1>>>0,this._s2=e*t,this._c=1,this}getUniform(){let e=2091639*this._s0+this._c*t;return this._s0=this._s1,this._s1=this._s2,this._c=0|e,this._s2=e-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,r;do{i=2*this.getUniform()-1,s=2*this.getUniform()-1,r=i*i+s*s}while(r>1||0==r);return t+i*Math.sqrt(-2*Math.log(r)/r)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,s=this.getUniform()*e,r=0;for(i in t)if(r+=t[i],s<r)return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new e).setState(this.getState())}}(new e).setSeed(Date.now());class i{getContainer(){return null}setOptions(t){this._options=t}}class s extends i{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){const t=this._ctx.globalCompositeOperation;this._ctx.globalCompositeOperation="copy",this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.globalCompositeOperation=t}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}class r extends s{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,r,n,a]=t,o=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&o.reverse(),e&&(this._ctx.fillStyle=a,this._fill(o[0],o[1])),!r)return;this._ctx.fillStyle=n;let h=[].concat(r);for(let t=0;t<h.length;t++)this._ctx.fillText(h[t],o[0],Math.ceil(o[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,s=e/(2+1.5*(this._options.height-1)),r=Math.min(i,s),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let a=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;let o=a/100;r=Math.floor(r)+1;let h=2*r/(this._options.spacing*(1+o/Math.sqrt(3)));return Math.ceil(h)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return function(t,e){return(t%e+e)%e}(e=Math.floor(e/s),2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border;const r=this._ctx;r.beginPath(),this._options.transpose?(r.moveTo(t-i+s,e),r.lineTo(t-i/2+s,e+this._spacingX-s),r.lineTo(t+i/2-s,e+this._spacingX-s),r.lineTo(t+i-s,e),r.lineTo(t+i/2-s,e-this._spacingX+s),r.lineTo(t-i/2+s,e-this._spacingX+s),r.lineTo(t-i+s,e)):(r.moveTo(t,e-i+s),r.lineTo(t+this._spacingX-s,e-i/2+s),r.lineTo(t+this._spacingX-s,e+i/2-s),r.lineTo(t,e+i-s),r.lineTo(t-this._spacingX+s,e+i/2-s),r.lineTo(t-this._spacingX+s,e-i/2+s),r.lineTo(t,e-i+s)),r.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,s;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class n extends s{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){n.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[i,s,r,n,a]=t,o=""+r+n+a;if(o in this._canvasCache)e=this._canvasCache[o];else{let t=this._options.border;e=document.createElement("canvas");let i=e.getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=a,i.fillRect(t,t,e.width-t,e.height-t),r){i.fillStyle=n,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(r);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[o]=e}this._ctx.drawImage(e,i*this._spacingX,s*this._spacingY)}_drawNoCache(t,e){let[i,s,r,n,a]=t;if(e){let t=this._options.border;this._ctx.fillStyle=a,this._ctx.fillRect(i*this._spacingX+t,s*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!r)return;this._ctx.fillStyle=n;let o=[].concat(r);for(let t=0;t<o.length;t++)this._ctx.fillText(o[t],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),s=Math.floor(e/this._options.height),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let n=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let a=n/100*s/i;return a>1&&(s=Math.floor(s/a)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}n.cache=!1;class a extends s{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,r,n,a]=t,o=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*o,s*h,o,h):(this._ctx.fillStyle=a,this._ctx.fillRect(i*o,s*h,o,h))),!r)return;let l=[].concat(r),c=[].concat(n),u=[].concat(a);for(let t=0;t<l.length;t++){let e=this._options.tileMap[l[t]];if(!e)throw new Error(`Char "${l[t]}" not found in tileMap`);if(this._options.tileColorize){let r=this._colorCanvas,n=r.getContext("2d");n.globalCompositeOperation="source-over",n.clearRect(0,0,o,h);let a=c[t],l=u[t];n.drawImage(this._options.tileSet,e[0],e[1],o,h,0,0,o,h),"transparent"!=a&&(n.fillStyle=a,n.globalCompositeOperation="source-atop",n.fillRect(0,0,o,h)),"transparent"!=l&&(n.fillStyle=l,n.globalCompositeOperation="destination-over",n.fillRect(0,0,o,h)),this._ctx.drawImage(r,i*o,s*h,o,h)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],o,h,i*o,s*h,o,h)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}function o(t){let e,i;if(t in l)e=l[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map((t=>parseInt(t,16)));if(3==i.length)e=i.map((t=>17*t));else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map((t=>parseInt(t))):[0,0,0];l[t]=e}return e.slice()}function h(t,...e){for(let i=0;i<3;i++)for(let s=0;s<e.length;s++)t[i]+=e[s][i];return t}const l={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]};class c extends i{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){"string"==typeof t?alert(t):t instanceof Error&&alert(t.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",(()=>this._updateTexture(e))):this._updateTexture(e)}draw(t,e){const i=this._gl,s=this._options;let[r,n,a,o,h]=t,l=i.canvas.height-(n+1)*s.tileHeight;if(i.scissor(r*s.tileWidth,l,s.tileWidth,s.tileHeight),e&&(s.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...f(h)),i.clear(i.COLOR_BUFFER_BIT)),!a)return;let c=[].concat(a),u=[].concat(h),d=[].concat(o);i.uniform2fv(this._uniforms.targetPosRel,[r,n]);for(let t=0;t<c.length;t++){let e=this._options.tileMap[c[t]];if(!e)throw new Error(`Char "${c[t]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,s.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,e),s.tileColorize&&(i.uniform4fv(this._uniforms.tint,f(d[t])),i.uniform4fv(this._uniforms.bg,f(u[t]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(...f(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=function(t,e,i){const s=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(s)||"");const r=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r)||"");const n=t.createProgram();if(t.attachShader(n,s),t.attachShader(n,r),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(n)||"");return n}(t,d,g);return t.useProgram(e),function(t){const e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(t),u.forEach((i=>this._uniforms[i]=t.getUniformLocation(e,i))),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){!function(t,e){let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}(this._gl,t)}}const u=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],d="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),g="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim();let p={};function f(t){if(!(t in p)){let e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else e=o(t).map((t=>t/255)),e.push(1);p[t]=e}return p[t]}function _(t){const e=6/256;let i=o(t);return 36*Math.floor(i[0]*e)+6*Math.floor(i[1]*e)+1*Math.floor(i[2]*e)+16}class m extends i{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map(((t,i)=>Math.floor((t-e[i])/2)))}clear(){process.stdout.write(`[0;48;5;${_(this._options.bg)}m[2J`)}draw(t,e){let[i,s,r,n,a]=t,o=this._offset[0]+i,h=this._offset[1]+s,l=this.computeSize();if(o<0||o>=l[0])return;if(h<0||h>=l[1])return;if(o===this._cursor[0]&&h===this._cursor[1]||(process.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(o,h)),this._cursor[0]=o,this._cursor[1]=h),e&&(r||(r=" ")),!r)return;let c=function(t,e){return`[0;38;5;${_(t)};48;5;${_(e)}m`}(n,a);if(c!==this._lastColor&&(process.stdout.write(c),this._lastColor=c),"\t"!=r){let t=[].concat(r);process.stdout.write(t[0])}this._cursor[0]++,this._cursor[0]>=l[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const y=/%([bc]){([^}]*)}/g;function w(t,e,i,s){let r={type:0,value:t[e].value.substring(i+(s?1:0))};return t.splice(e+1,0,{type:1},r),t[e].value.substring(0,i)}const v={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},x={hex:r,rect:n,tile:a,"tile-gl":c,term:m},b={width:80,height:25,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class S{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},b,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let s=[this._options.bg,this._options.fg];this.draw(t,e,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=x[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,s,r){s||(s=this._options.fg),r||(r=this._options.bg);let n=`${t},${e}`;this._data[n]=[t,e,i,s,r],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[n]=!0)}drawOver(t,e,i,s,r){const n=`${t},${e}`,a=this._data[n];a?(a[2]=i||a[2],a[3]=s||a[3],a[4]=r||a[4]):this.draw(t,e,i,s,r)}drawText(t,e,i,s){let r=null,n=null,a=t,o=e,h=1;s||(s=this._options.width-t);let l=function(t,e){let i=[],s=0;t.replace(y,(function(e,r,n,a){let o=t.substring(s,a);return o.length&&i.push({type:0,value:o}),i.push({type:"c"==r?2:3,value:n.trim()}),s=a+e.length,""}));let r=t.substring(s);return r.length&&i.push({type:0,value:r}),function(t,e){e||(e=1/0);let i=0,s=0,r=-1;for(;i<t.length;){let n=t[i];if(1==n.type&&(s=0,r=-1),0!=n.type){i++;continue}for(;0==s&&" "==n.value.charAt(0);)n.value=n.value.substring(1);let a=n.value.indexOf("\n");if(-1!=a){n.value=w(t,i,a,!0);let e=n.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();n.value=e.join("")}if(n.value.length){if(s+n.value.length>e){let a=-1;for(;;){let t=n.value.indexOf(" ",a+1);if(-1==t)break;if(s+t>e)break;a=t}if(-1!=a)n.value=w(t,i,a,!0);else if(-1!=r){let e=t[r],s=e.value.lastIndexOf(" ");e.value=w(t,r,s,!0),i=r}else n.value=w(t,i,e-s,!1)}else s+=n.value.length,-1!=n.value.indexOf(" ")&&(r=i);i++}else t.splice(i,1)}t.push({type:1});let n=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case 0:n=i;break;case 1:if(n){let t=n.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();n.value=t.join("")}n=null}}return t.pop(),t}(i,e)}(i,s);for(;l.length;){let e=l.shift();switch(e.type){case 0:let i=!1,s=!1,l=!1,c=!1;for(let t=0;t<e.value.length;t++){let h=e.value.charCodeAt(t),u=e.value.charAt(t);if("term"===this._options.layout){let t=h>>8;if(17===t||t>=46&&t<=159||t>=172&&t<=215||h>=43360&&h<=43391){this.draw(a+0,o,u,r,n),this.draw(a+1,o,"\t",r,n),a+=2;continue}}l=h>65280&&h<65377||h>65500&&h<65512||h>65518,i=32==u.charCodeAt(0)||12288==u.charCodeAt(0),!c||l||i||a++,l&&!s&&a++,this.draw(a++,o,u,r,n),s=i,c=l}break;case 2:r=e.value||null;break;case 3:n=e.value||null;break;case 1:a=t,o++,h++}}return h}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}S.Rect=n,S.Hex=r,S.Tile=a,S.TileGL=c,S.Term=m;class C{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let s,r,n,a=[];switch(this._options.topology){case 4:r=1,n=[0,1],s=[v[8][7],v[8][1],v[8][3],v[8][5]];break;case 6:s=v[6],r=1,n=[-1,1];break;case 8:s=v[4],r=2,n=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let o=t+n[0]*i,h=e+n[1]*i;for(let t=0;t<s.length;t++)for(let e=0;e<i*r;e++)a.push([o,h]),o+=s[t][0],h+=s[t][1];return a}}const M=class extends C{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let r,n,a,o,h,l,c=[];for(let u=1;u<=i;u++){let i=this._getCircle(t,e,u),d=i.length;for(let t=0;t<d;t++)if(r=i[t][0],n=i[t][1],o=[t?2*t-1:2*d-1,2*d],h=[2*t+1,2*d],a=!this._lightPasses(r,n),l=this._checkVisibility(o,h,a,c),l&&s(r,n,u,l),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return}}_checkVisibility(t,e,i,s){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,s)+this._checkVisibility([0,1],e,i,s))/2;let r=0,n=!1;for(;r<s.length;){let e=s[r],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0!=i||r%2||(n=!0);break}r++}let a=s.length,o=!1;for(;a--;){let t=s[a],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0==i&&a%2&&(o=!0);break}}let h,l=!0;if((r==a&&(n||o)||n&&o&&r+1==a&&a%2||r>a&&r%2)&&(l=!1),!l)return 0;let c=a-r+1;if(c%2)if(r%2){let t=s[r];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c,e)}else{let e=s[a];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c,t)}else{if(!(r%2))return i&&s.splice(r,c,t,e),1;{let t=s[r],e=s[a];h=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c)}}return h/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}};Math.sqrt(3),Math.sqrt(3);class T{constructor(t,e={}){this._reflectivityCallback=t,this._options={},e=Object.assign({passes:1,emissionThreshold:100,range:10},e),this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(e)}setOptions(t){return Object.assign(this._options,t),t&&t.range&&this.reset(),this}setFOV(t){return this._fov=t,this._fovCache={},this}setLight(t,e,i){let s=t+","+e;return i?this._lights[s]="string"==typeof i?o(i):i:delete this._lights[s],this}clearLights(){this._lights={}}reset(){return this._reflectivityCache={},this._fovCache={},this}compute(t){let e={},i={},s={};for(let t in this._lights){let e=this._lights[t];i[t]=[0,0,0],h(i[t],e)}for(let t=0;t<this._options.passes;t++)this._emitLight(i,s,e),t+1!=this._options.passes&&(i=this._computeEmitters(s,e));for(let e in s){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]),s[e])}return this}_emitLight(t,e,i){for(let s in t){let r=s.split(","),n=parseInt(r[0]),a=parseInt(r[1]);this._emitLightFromCell(n,a,t[s],e),i[s]=1}return this}_computeEmitters(t,e){let i={};for(let s in t){if(s in e)continue;let r,n=t[s];if(s in this._reflectivityCache)r=this._reflectivityCache[s];else{let t=s.split(","),e=parseInt(t[0]),i=parseInt(t[1]);r=this._reflectivityCallback(e,i),this._reflectivityCache[s]=r}if(0==r)continue;let a=[0,0,0],o=0;for(let t=0;t<3;t++){let e=Math.round(n[t]*r);a[t]=e,o+=e}o>this._options.emissionThreshold&&(i[s]=a)}return i}_emitLightFromCell(t,e,i,s){let r,n=t+","+e;r=n in this._fovCache?this._fovCache[n]:this._updateFOV(t,e);for(let t in r){let e,n=r[t];t in s?e=s[t]:(e=[0,0,0],s[t]=e);for(let t=0;t<3;t++)e[t]+=Math.round(i[t]*n)}return this}_updateFOV(t,e){let i=t+","+e,s={};this._fovCache[i]=s;let r=this._options.range;return this._fov.compute(t,e,r,function(t,e,i,n){let a=n*(1-i/r);0!=a&&(s[t+","+e]=a)}.bind(this)),s}}function E(t,e){if(t)throw new Error("function"==typeof e?e():e)}function L(t,e){return E(!t,e),t}function k(t){return E(0===t.length,"need at least one element"),t[Math.floor(Math.random()*t.length)]}function P(t,e){E(t<0,"Cannot iterate negatively");for(let i=0;i<t;i++)e(i)}function z(t,e){for(let i=0;i<t.length;i++)e(t[i],i)}const R=t=>Math.random()<1/t,O=t=>L(document.getElementById(t),(()=>`No ${t} element`)),I=(t,e)=>t.addEventListener("click",e),A="#0a0",F="#000",N="#444",X=["#ff6600","#ff9900","#ffcc00","#ff3300"],$=["#333","#555","#666","#777","#888","#999","#aaa","#bbb","#ccc"];class B{constructor(t,e){this.x=t,this.y=e,this.add=(t,e)=>new B(this.x+t,this.y+e),this.sub=(t,e)=>new B(this.x-t,this.y-e),this.u=t=>this.add(0,-t),this.d=t=>this.add(0,t),this.l=t=>this.add(-t,0),this.r=t=>this.add(t,0),this.draw=(t,e,i,s=F)=>t.draw(this.x,this.y,e,i,s),this.cell=t=>t[this.y][this.x],this.neighbors=()=>[this.u(1),this.d(1),this.l(1),this.r(1)],this.toString=()=>`${this.x}, ${this.y}`}random(){const t=Math.floor(4*Math.random());if(0===t)return this.u(1);if(1===t)return this.d(1);if(2===t)return this.l(1);if(3===t)return this.r(1);throw new Error("Invalid direction")}}B.at=(t,e)=>new B(t,e);class U{constructor(){this.data={}}draw(t,e,i,s,r){U.layerNames.some((n=>{if(i.size>0&&!i.has(n))return!1;const a=this.data[n];return!!a?.draw&&a.draw(t,e,s,r)}))}step(t){U.layerNames.forEach((e=>{const i=this.data[e];i&&(i.age++,i.step(t))}))}set(t){this.data[t.layer]=t}remove(t){delete this.data[t.layer]}passable(){return U.layerNames.every((t=>{const e=this.data[t];return e?.passable??!0}))}transparency(){if(this.data.ui)return this.data.ui.transparency;if(this.lit())return 1;const t=U.layerNames.map((t=>this.data[t]?.transparency)).filter((t=>void 0!==t));return t.length>0?Math.min(...t):1}lit(){return U.layerNames.some((t=>{const e=this.data[t];return e&&e.light()>0}))}}U.layerNames=["ui","squaddies","smoke","fire","walls","items","floor"];class W{constructor(t,e){this.layers=new U,this.passable=()=>this.layers.passable(),this.neighbors=()=>this.xy.neighbors().map((t=>this.map.get(t))),this.xy=t,this.map=e}draw(t,e,i,s,r){const n=this.map.lighting.illumination(this.xy.x,this.xy.y);if(e){const e=Math.floor(n).toString();if("0"!==e)return void t.draw(this.xy.x,this.xy.y,e,"#fff","#000")}s||this.layers.draw(t,this,i,r,n)}step(){this.layers.step(this)}set(t){this.layers.set(t)}remove(t){this.layers.remove(t),this.map.lighting.update(this)}move(t,e){this.remove(t),this.map.set(e,t)}}class D{constructor(t){this.map=t,this._sources=new Set,this.rotLighting=new T(((t,e)=>{if(this.map.oob(t,e))return 0;const i=this.map.get(B.at(t,e));return i?.layers.transparency()??0}),{range:6,passes:2});const e=new M(((t,e)=>{if(this.map.oob(t,e))return!1;const i=this.map.get(B.at(t,e));return(i?.layers.transparency()??0)>0}),{topology:8});this.rotLighting.setFOV(e),this._illumination=Array.from({length:t.h},(()=>new Array(t.w))),this.clear()}clear(){this.rotLighting.clearLights(),this._illumination.forEach((t=>t.fill(0)))}add(t){this._sources.add(t)}remove(t){this._sources.delete(t)}update(t){t.layers.lit()?this.add(t):this.remove(t)}redraw(){this.clear();for(const t of this._sources){const e=t.layers.data;let i=0;Object.values(e).forEach((t=>{t&&(i+=t.light())})),i=Math.min(i,9),this.rotLighting.setLight(t.xy.x,t.xy.y,[i,i,i])}this.rotLighting.compute(((t,e,i)=>{this._illumination[e][t]=Math.max(i[0],i[1],i[2])}))}illumination(t,e){return this._illumination[e][t]}sources(){return this._sources}lit(t){return this._sources.has(t)}}class H{constructor(t,e,i){this.display=t,this.get=t=>{const e=t.cell(this.grid);return L(e,(()=>"No cell at "+t)),e},this.w=e,this.h=i,this.grid=[],P(i,(t=>{this.grid[t]=[],P(e,(e=>{this.grid[t][e]=new W(B.at(e,t),this)}))})),this.lighting=new D(this)}draw(t,e,i,s){this.display.clear(),P(this.h,(r=>{P(this.w,(n=>{this.grid[r][n].draw(this.display,t,e,i,s)}))}))}step(){P(this.h,(t=>{P(this.w,(e=>{this.grid[t][e].step()}))}))}set(t,e){const i=t.cell(this.grid);i.set(e),this.lighting.update(i)}oob(t,e){return t<0||t>=this.w||e<0||e>=this.h}onMousemove(t,e){var i;i=i=>{const s=t.getBoundingClientRect(),r=Math.floor((i.clientX-s.left)/16),n=Math.floor((i.clientY-s.top)/16);if(r>=0&&r<90&&n>=0&&n<50){const t=this.get(B.at(r,n));e(t)}},t.addEventListener("mousemove",i)}}class Y{constructor(){this.age=0,this.passable=!0,this.transparency=1}step(t){}draw(t,e,i,s){const r=this.applyIllumination(this.color(e),s);return t.draw(e.xy.x,e.xy.y,this.char(e),r,F),!0}applyIllumination(t,e){const i=Math.min(e,9)/9,s=Math.max(.1,i);if(t.startsWith("#")){let e,i,r;if(4===t.length)e=parseInt(t[1]+t[1],16),i=parseInt(t[2]+t[2],16),r=parseInt(t[3]+t[3],16);else{if(7!==t.length)return t;e=parseInt(t.slice(1,3),16),i=parseInt(t.slice(3,5),16),r=parseInt(t.slice(5,7),16)}const n=Math.floor(e*s),a=Math.floor(i*s),o=Math.floor(r*s);return`#${n.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`}return t}}class q extends Y{constructor(){super(...arguments),this.layer="smoke",this.transparency=0,this.light=()=>0,this.char=t=>"+",this.color=t=>k($)}draw(t,e,i,s){return!(!i&&R(2))&&super.draw(t,e,i,s)}step(t){if(R(this.age/3)||t.remove(this),R(4)){const e=t.xy.random();t.map.get(e).passable()&&t.move(this,e)}}}class V extends Y{constructor(){super(...arguments),this.layer="fire",this.light=()=>5,this.char=t=>"▲",this.color=t=>k(X)}step(t){R(this.age)?(t.set(new q),t.layers.data.walls&&t.layers.data.walls.ignite(),R(4)&&k(t.neighbors()).set(new V)):t.remove(this)}}class G extends Y{constructor(){super(...arguments),this.layer="walls",this.passable=!1,this.transparency=0,this.burningFor=null,this.char=t=>"#",this.color=t=>this.isBurning()?"#6c200e":N,this.light=()=>this.isBurning()?3:0,this.isBurning=()=>null!==this.burningFor}step(t){this.isBurning()&&(R(2)&&t.set(new q),this.burningFor<=0?t.remove(this):(this.burningFor--,R(2)&&t.set(new V)))}ignite(){this.isBurning()||(this.burningFor=10)}}class j extends Y{constructor(t,e=A){super(),this.c=t,this.textColor=e,this.layer="ui",this.light=()=>0,this.char=t=>this.c,this.color=t=>this.textColor,this.step=t=>t.remove(this)}}class K{constructor(t,e,i){this.xy=t,this.w=e,this.h=i,this.eachCell=t=>P(this.w,(e=>P(this.h,(i=>t(this.xy.add(e,i))))))}get ul(){return this.xy}get ur(){return this.xy.add(this.w-1,0)}get ll(){return this.xy.add(0,this.h-1)}get lr(){return this.xy.add(this.w-1,this.h-1)}eachBorder(t){P(this.w,(e=>{t(this.xy.add(e,0)),t(this.xy.add(e,this.h-1))})),P(this.h-2,(e=>{t(this.xy.add(0,e+1)),t(this.xy.add(this.w-1,e+1))}))}}K.xyWH=(t,e,i)=>new K(t,e,i);class J extends Y{constructor(){super(...arguments),this.layer="floor",this.light=()=>0,this.char=t=>".",this.color=t=>N}}class Q extends Y{constructor(){super(...arguments),this.layer="items",this.transparency=0,this.light=()=>9,this.char=t=>"*",this.color=t=>k(X)}step(t){R(3)&&t.set(new q)}}const Z=["#   #  ###  ####  #     ####       ###  #   #      ##### ##### ####  #####","#   # #   # #   # #     #   #     #   # ##  #      #       #   #   # #    ","# # # #   # ####  #     #   #     #   # # # #      ####    #   ####  #### ","# # # #   # #   # #     #   #     #   # #  ##      #       #   #   # #    ","## ## #   # #   # #     #   #     #   # #   #      #       #   #   # #    ","#   #  ###  #   # ##### ####       ###  #   #      #     ##### #   # #####"];class tt{constructor(t){this.map=t}initialize(){this.addField(),this.addTitle(),this.addWelcomeText()}addField(){K.xyWH(B.at(0,0),this.map.w,this.map.h).eachCell((t=>{this.map.set(t,new J)}))}addTitle(){const t=Z[0].length,e=Z.length,i=Math.floor((this.map.w-t)/2),s=Math.floor((this.map.h-e)/2),r=B.at(i,s),n=K.xyWH(r.add(-1,-1),t+2,e+2);n.eachCell((t=>this.map.set(t,new J))),z(Z,((t,e)=>{z(t,((t,i)=>{"#"===t&&this.map.set(r.add(i,e),new V)}))})),n.eachBorder((t=>{this.map.set(t,new G)})),[n.ul.add(1,1),n.ur.add(-1,1),n.ll.add(1,-1),n.lr.add(-1,-1)].forEach((t=>{this.map.set(t,new Q)}))}addWelcomeText(){this.addCenteredText("Welcome to Fire House RL",-13),this.addCenteredText("press space to unpause",5)}addCenteredText(t,e){const i=Math.floor(this.map.h/2)+e,s=Math.floor((this.map.w-t.length)/2),r=B.at(s,i);z(t,((t,e)=>this.map.set(r.add(e,0),new j(t))))}}class et{constructor(t){this.currentCell=null,this.setCurrent=t=>this.currentCell=t,this.clear=()=>this.element.innerHTML="",this.element=O(t)}draw(){if(!this.currentCell)return void(this.element.innerHTML='<div class="layer-info">no cell selected</div>');const t=this.currentCell.layers.transparency(),e=this.currentCell.map.lighting.lit(this.currentCell),i=this.currentCell.map.lighting.illumination(this.currentCell.xy.x,this.currentCell.xy.y);let s=`<div class="cell-coord">${this.currentCell.xy.x}, ${this.currentCell.xy.y}</div>`;s+=`<div class="layer-info">transparency: ${t}</div>`,s+=`<div class="layer-info">light source: ${e}</div>`,s+=`<div class="layer-info">illumination: ${i.toFixed(3)}</div>`;const r=this.currentCell.layers.data,n=U.layerNames.filter((t=>r[t])).map((t=>[t,r[t]]));0===n.length?s+='<div class="layer-info">empty</div>':n.forEach((([t,e])=>{const i=e.color(this.currentCell),r=e.light()>0?` (light: ${e.light()})`:"";s+=`<div class="layer-info">${t}: <span style="color: ${i}">${e.constructor.name}${r}</span></div>`})),this.element.innerHTML=s}}class it{constructor(){this.intervalId=null,this.running=!1,this.showLighting=!1,this.mutedLayers=new Set,this.soloLayer=null,this.display=this.createDisplay(),this.map=new H(this.display,90,50),this.terminal=new et("terminal-content"),this.attachToDOM(),this.setupControls(),this.setupDebugControls(),new tt(this.map).initialize(),this.map.lighting.redraw(),this.drawMap(),this.updatePlayPauseButton(),document.addEventListener("keydown",(t=>{" "===t.key&&(t.preventDefault(),this.togglePlayPause())}))}createDisplay(){return new S({width:90,height:50,fontSize:16,fontFamily:"Courier, monospace",forceSquareRatio:!0,fg:A,bg:F})}attachToDOM(){const t=L(document.getElementById("game-container"),(()=>"No game-container element")),e=L(this.display.getContainer(),(()=>"Failed to get canvas"));t.appendChild(e),this.map.onMousemove(e,(t=>{this.terminal.setCurrent(t),this.terminal.draw()}))}setupControls(){I(O("playpause-button"),(()=>this.togglePlayPause())),I(O("next-button"),(()=>this.step()))}setupDebugControls(){I(O("lighting-toggle"),(()=>this.toggleLighting())),I(O("layer-on"),(()=>this.turnOnAllLayers())),I(O("layer-off"),(()=>this.turnOffAllLayers())),this.createLayerButtons(),U.layerNames.forEach((t=>{I(O(`layer-${t}`),(()=>this.toggleLayerVisibility(t)))}))}updatePlayPauseButton(){O("playpause-button").textContent=this.running?"⏸":"▶"}togglePlayPause(){this.running?this.pause():this.play()}pause(){this.running&&(this.running=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.updatePlayPauseButton())}play(){this.running||(this.running=!0,this.intervalId=setInterval((()=>{this.map.step(),this.drawMap(),this.map.lighting.redraw(),this.terminal.draw()}),350),this.updatePlayPauseButton())}step(){this.map.step(),this.drawMap(),this.map.lighting.redraw(),this.terminal.draw()}drawMap(){const t=this.getVisibleLayers(),e=this.mutedLayers.size===U.layerNames.length,i=this.mutedLayers.size>0||null!==this.soloLayer;this.map.draw(this.showLighting,t,e,i)}getVisibleLayers(){return this.soloLayer?new Set([this.soloLayer]):0===this.mutedLayers.size?new Set:new Set(U.layerNames.filter((t=>!this.mutedLayers.has(t))))}toggleLighting(){this.showLighting=!this.showLighting,O("lighting-toggle").textContent=this.showLighting?"LT*":"LT",this.drawMap()}toggleLayerVisibility(t){const e=O(`layer-${t}`);this.soloLayer===t?(this.soloLayer=null,e.classList.remove("solo")):this.soloLayer?(O(`layer-${this.soloLayer}`).classList.remove("solo"),this.soloLayer=t,e.classList.add("solo")):this.mutedLayers.has(t)?(this.mutedLayers.delete(t),e.classList.remove("muted")):(this.mutedLayers.add(t),e.classList.add("muted")),this.drawMap()}turnOnAllLayers(){this.mutedLayers.clear(),this.soloLayer=null,U.layerNames.forEach((t=>{O(`layer-${t}`).classList.remove("muted","solo")})),this.drawMap()}turnOffAllLayers(){this.soloLayer=null,this.mutedLayers=new Set(U.layerNames),U.layerNames.forEach((t=>{const e=O(`layer-${t}`);e.classList.remove("solo"),e.classList.add("muted")})),this.drawMap()}get gameMap(){return this.map}get gameDisplay(){return this.display}draw(){this.drawMap()}createLayerButtons(){const t=O("layer-group"),e=Object.fromEntries(U.layerNames.map((t=>[t,"ui"===t?"ui ":t.slice(0,3)])));U.layerNames.forEach((i=>{const s=document.createElement("button");s.id=`layer-${i}`,s.className="layer-button",s.textContent=e[i]||i.slice(0,3),t.appendChild(s)}))}}function st(t,e){const i=document.getElementById("game-container")||document.body,s=document.createElement("div");s.className="error-overlay";const r=document.createElement("button");r.className="error-close",r.textContent="×",r.addEventListener("click",(()=>s.remove())),s.textContent=`ERROR: ${t}\n\nStack trace:\n${e||"No stack trace available"}`,s.appendChild(r),i.appendChild(s)}window.addEventListener("error",(t=>{console.error("Global error:",t.error),console.error("Stack trace:",t.error?.stack),st(t.error?.message||"Unknown error",t.error?.stack)})),window.addEventListener("DOMContentLoaded",(function(){try{new it}catch(t){st(`Game initialization failed: ${t instanceof Error?t.message:"Unknown error"}`,t instanceof Error?t.stack:void 0)}}))})();